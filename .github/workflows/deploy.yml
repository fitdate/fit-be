name: Deploy Backend Application

on:
  push:
    branches: [main, develop]
    paths:
      - '**.ts'
      - 'package*.json'
      - 'tsconfig*.json'
      - '.env.example'
      - 'nest-cli.json'
      - '.github/workflows/**'
      - 'Dockerfile'
      - 'nginx-config/**'
      - '!frontend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Configure SSH and Create .env
        run: |
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          echo "ServerAliveInterval 30" >> ~/.ssh/config
          echo "ServerAliveCountMax 60" >> ~/.ssh/config
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Build Docker image
        run: |
          docker build -t fit-be:$GITHUB_SHA .
          docker tag fit-be:$GITHUB_SHA ${{ secrets.DOCKER_USERNAME }}/fit-be:$GITHUB_SHA
          docker tag fit-be:$GITHUB_SHA ${{ secrets.DOCKER_USERNAME }}/fit-be:latest

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/fit-be:$GITHUB_SHA
          docker push ${{ secrets.DOCKER_USERNAME }}/fit-be:latest

      - name: Test Database Connection
        run: |
          if [ -z "${{ secrets.DB_HOST }}" ]; then
            echo "‚ùå DB_HOST environment variable is not set"
            exit 1
          fi
          echo "Testing database connection to ${{ secrets.DB_HOST }}:5432"
          nc -zv ${{ secrets.DB_HOST }} 5432 || {
            echo "‚ùå Database connection test failed"
            exit 1
          }
          echo "‚úÖ Database connection test successful"

      - name: Deploy to EC2
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          BLUE_PORT: 3000
          GREEN_PORT: 3001
        run: |
          ssh -o ConnectTimeout=10 $USERNAME@$DB_HOST "echo 'SSH connection test successful'"

          # Nginx ÏÑ§Ï†ï ÌååÏùº ÏóÖÎ°úÎìú
          ssh $USERNAME@$DB_HOST "sudo mkdir -p /etc/nginx/sites-available"
          scp nginx-config/fit-blue.conf $USERNAME@$DB_HOST:~/fit-blue.conf
          scp nginx-config/fit-green.conf $USERNAME@$DB_HOST:~/fit-green.conf
          ssh $USERNAME@$DB_HOST "sudo mv ~/fit-blue.conf /etc/nginx/sites-available/ && sudo mv ~/fit-green.conf /etc/nginx/sites-available/"
          ssh $USERNAME@$DB_HOST "sudo mkdir -p /etc/nginx/sites-enabled"

          # ÌòÑÏû¨ Ïã§Ìñâ Ï§ëÏù∏ Ïª®ÌÖåÏù¥ÎÑà Ìè¨Ìä∏ ÌôïÏù∏
          CURRENT_PORT=$(ssh $USERNAME@$DB_HOST "curl -s localhost/port || echo $BLUE_PORT")
          if [ "$CURRENT_PORT" = "$BLUE_PORT" ]; then
            NEW_PORT=$GREEN_PORT
            NEW_ENV="green"
            CURRENT_ENV="blue"
          else
            NEW_PORT=$BLUE_PORT
            NEW_ENV="blue"
            CURRENT_ENV="green"
          fi

          # .env ÌååÏùº Ï†ÑÏÜ°
          scp .env $USERNAME@$DB_HOST:~/

          # Blue-Green Î∞∞Ìè¨ Ïã§Ìñâ
          ssh $USERNAME@$DB_HOST "
            set -e
            
            echo 'üê≥ Docker Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú Ï§ë...'
            docker pull $DOCKER_USERNAME/fit-be:$GITHUB_SHA
            
            echo 'üöÄ ÏÉà Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë Ï§ë...'
            # Ïù¥ÎØ∏ Ìï¥Îãπ Ïù¥Î¶ÑÏùò Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä ÏûàÏúºÎ©¥ Ï§ëÏßÄ Î∞è ÏÇ≠Ï†ú
            docker stop fit-$NEW_ENV 2>/dev/null || true
            docker rm fit-$NEW_ENV 2>/dev/null || true
            
            # ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
            docker run -d --name fit-$NEW_ENV \
              -p $NEW_PORT:3000 \
              -v ~/:/app \
              -e APP_PORT=$NEW_PORT \
              --restart unless-stopped \
              $DOCKER_USERNAME/fit-be:$GITHUB_SHA
            
            echo 'üîÑ Nginx ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...'
            sudo ln -sf /etc/nginx/sites-available/fit-$NEW_ENV.conf /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl reload nginx
            
            echo 'üè• Health checking...'
            for i in {1..12}; do
              echo \"Attempt \$i: Checking http://localhost:$NEW_PORT/health\"
              if curl -s http://localhost:$NEW_PORT/health; then
                # ÏÑ±Í≥µ Ïãú Ïù¥Ï†Ñ ÌôòÍ≤Ω Ï†ïÎ¶¨
                docker stop fit-$CURRENT_ENV 2>/dev/null || true
                docker rm fit-$CURRENT_ENV 2>/dev/null || true
                sudo rm -f /etc/nginx/sites-enabled/fit-$CURRENT_ENV.conf
                sudo nginx -t && sudo systemctl reload nginx
                echo '‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ'
                exit 0
              fi
              sleep 5
            done
            
            echo '‚ùå Î∞∞Ìè¨ Ïã§Ìå®: Ìó¨Ïä§ Ï≤¥ÌÅ¨ Ïã§Ìå®'
            docker logs fit-$NEW_ENV
            docker stop fit-$NEW_ENV
            docker rm fit-$NEW_ENV
            exit 1
          "
